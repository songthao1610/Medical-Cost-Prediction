---
output:
  html_document: default
  pdf_document: default
---
```
title: "Notebook"
author: "Thao Nguyen"
output: pdf_document
```
```{r setup, include=FALSE}
options(repos = c(CRAN = "https://cran.rstudio.com/"))
```

```{r}
# Install necessary packages
install.packages('tinytex')
tinytex::install_tinytex(force = TRUE)
install.packages('ggplot2')
install.packages('dplyr')
install.packages('tidyr')
install.packages('gridExtra')
install.packages('ggExtra')
install.packages('ggridges')
install.packages('corrplot')
install.packages('rsample')


# Load the installed packages
library(tidyr)
library(gridExtra)
library(dplyr)
library(ggplot2)
library(ggExtra)
library(ggridges)
library(corrplot)
library(rsample)

```
```{r}
df = read.csv('C:/Users/songt/R projects/Medical Cost Prediction/insurance.csv', header = TRUE)
head(df)
```
```{r}
summary(df)

```
```{r}
str(df)

```
```{r}
# Create the scatter plot of 'charges' versus 'bmi'
g <- ggplot(df, aes(x = bmi, y = charges)) +
  geom_point() +  # Add points to the plot
  theme(legend.position = 'none') +  # Remove legend
  ggtitle("Scatter Plot of Charges by BMI") +  # Add plot title
  theme(
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, vjust = 0.5)  # Customize title
  )

# Add marginal histograms to the scatter plot
g1 <- ggMarginal(
  g, type = "histogram", fill = 'lightblue', xparams = list(bins = 10)
)

# Display the final plot
g1
```

```{r}
# Create the scatter plot of 'charges' versus 'age'
p <- ggplot(df, aes(x = age, y = charges)) +
  geom_point() +  # Add points to the plot
  theme(legend.position = 'none') +  # Remove legend
  ggtitle("Scatter Plot of Charges by Age") +  # Add plot title
  theme(
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, vjust = 0.5)  # Customize title
  )

# Display the plot
p
```
```{r}
# Create age groups in the data frame
df$age_group <- cut(
  df$age,
  breaks = c(0, 18, 35, 50, 60, 100),  # Define age group boundaries
  labels = c('0-18', '19-35', '36-50', '50-60', '60-100'),  # Label each age group
  right = FALSE  # Ensure the interval includes the left value but excludes the right
)

# Boxplot: Charges by Age Group
g1 <- ggplot(df, aes(x = factor(age_group), y = charges, fill = age_group)) +
  geom_boxplot() +  # Create boxplots
  theme(legend.position = 'none') +  # Remove legend
  ggtitle("Charges by Age") +  # Add plot title
  theme(plot.title = element_text(colour = 'black', face = 'bold', size = 12, hjust = 0.5, vjust = 0.5)) +
  xlab('Age') +  # Label the x-axis
  ylab('Charges')  # Label the y-axis

# Barplot: Count of Age Groups
g2 <- ggplot(df, aes(x = age_group, fill = factor(age_group))) +
  geom_bar() +  # Create a bar plot
  theme(legend.position = 'none') +  # Remove legend
  ggtitle("Countplot for Age Group") +  # Add plot title
  theme(plot.title = element_text(colour = 'black',face = 'bold', size = 12, hjust = 0.5, vjust = 0.5)) +
  xlab('Age') +  # Label the x-axis
  ylab('Count')  # Label the y-axis

# Arrange the plots side by side
grid.arrange(g1, g2, ncol = 2)

```

```{r}
# Histogram: Distribution of Charges
g1 <- ggplot(df, aes(x = charges)) +
  geom_histogram(fill = 'slateblue') +  # Create a histogram with slate blue color
  theme(legend.position = 'none') +  # Remove legend
  ggtitle("Distribution of Charges") +  # Add plot title
  theme(plot.title = element_text(colour = 'black', face ='bold',size = 14, hjust = 0.5, vjust = 0.5)) +
  xlab('Charges') +  # Label the x-axis
  ylab('')  # Remove y-axis label

# Boxplot: Charges by Number of Children
g2 <- ggplot(df, aes(x = factor(children), y = charges, fill = factor(children))) +
  geom_boxplot() +  # Create boxplots
  theme(legend.position = 'none') +  # Remove legend
  ggtitle("Charges by No. Children") +  # Add plot title
  theme(plot.title = element_text(face = 'bold', colour = 'black', size = 12, hjust = 0.5, vjust = 0.5)) +
  xlab('Children') +  # Label the x-axis
  ylab('Charges')  # Label the y-axis

# Barplot: Count by Number of Children
g3 <- ggplot(df, aes(x = children, fill = factor(children))) +
  geom_bar() +  # Create a bar plot
  theme(legend.position = 'none') +  # Remove legend
  ggtitle("Countplot by No. Children") +  # Add plot title
  theme(plot.title = element_text(colour = 'black',face ='bold', size = 12, hjust = 0.5, vjust = 0.5)) +
  xlab('Children') +  # Label the x-axis
  ylab('Count')  # Label the y-axis

# Arrange the plots
grid.arrange(
  g2,  # Place the boxplot (g2) on top
  arrangeGrob(g1, g3, ncol = 2),  # Arrange histogram (g1) and bar plot (g3) side by side below g2
  nrow = 2  # Display the plots in two rows
)

```
```{r}
# Density Plot: Charges by Sex
g1 <- ggplot(data = df, aes(x = charges, fill = sex)) +
  geom_density(alpha = 0.5) +  # Create a density plot with transparency
  scale_fill_manual(values = c('salmon', 'lightblue')) +  # Set custom colors for sexes
  ggtitle("Density Plot of Charges\nby Sex") +  # Add plot title with a newline for better display
  theme(
    plot.title = element_text(colour = 'black', face ='bold', size = 12, hjust = 0.5, vjust = 0.5)  # Customize title
  ) +
  xlab('Charges') +  # Label the x-axis
  ylab('Density')  # Label the y-axis

# Boxplot: Charges by Sex
g2 <- ggplot(data = df, aes(x = factor(sex), y = charges, fill = sex)) +
  geom_boxplot() +  # Create boxplots
  scale_fill_manual(values = c('salmon', 'lightblue')) +  # Set custom colors for sexes
  ggtitle("Boxplot of Charges\nby Sex") +  # Add plot title with a newline for better display
  theme(
    plot.title = element_text(colour = 'black',face ='bold', size = 12, hjust = 0.5, vjust = 0.5),  # Customize title
    legend.position = 'none'  # Remove legend
  ) +
  xlab('Sex') +  # Label the x-axis
  ylab('Charges')  # Label the y-axis

# Arrange the plots side by side
grid.arrange(g2, g1, ncol = 2, widths = c(0.5, 1))


```
```{r}
# Density Plot: Charges by Smoking Status
g1 <- ggplot(data = df, aes(x = charges, fill = smoker)) +
  geom_density(alpha = 0.5) +  # Create a density plot 
  scale_fill_manual(values = c('cornsilk1', 'brown')) +  # Set custom colors for smokers and non-smokers
  ggtitle("Density Plot of Charges by\nwhether a person is a smoker") +  # Add plot title with a newline for better display
  theme(
    plot.title = element_text(colour = 'black',face ='bold', size = 11, hjust = 0.5, vjust = 0.5)  # Customize title
  ) +
  xlab('Charges') +  # Label the x-axis
  ylab('Density')  # Label the y-axis

# Boxplot: Charges by Smoking Status
g2 <- ggplot(data = df, aes(x = factor(smoker), y = charges, fill = smoker)) +
  geom_boxplot() +  # Create boxplots
  scale_fill_manual(values = c('cornsilk1', 'brown')) +  # Set custom colors for smokers and non-smokers
  ggtitle("Boxplot of Charges by\nwhether a person is a smoker") +  # Add plot title with a newline for better display
  theme(
    plot.title = element_text(colour = 'black', face ='bold', size = 11, hjust = 0.5, vjust = 0.5),  # Customize title
    legend.position = 'none'  # Remove legend
  ) +
  xlab('Smoker') +  # Label the x-axis
  ylab('Charges')  # Label the y-axis

# Arrange the plots in a grid
grid.arrange(g2, g1, ncol = 2, widths = c(0.6, 1))


```
```{r}
# Density Ridges Plot: Distributions of Charges by Region
ggplot(df, aes(x = charges, y = region, fill = region)) +
  geom_density_ridges() +  # Create density ridges to visualize distributions
  theme_ridges() +  # Use the ridges theme for better visual appeal
  theme(
    legend.position = 'none',  # Remove legend
    plot.title = element_text(size = 12, face = 'bold', hjust = 0.5)  # Customize plot title
  ) +
  ggtitle('Distributions of Charges by Regions') +  # Add plot title
  xlab('') +  # No x-axis label
  ylab('')  # No y-axis label

```
```{r}
# Density Plot: Charges by Gender and Age Group
ggplot(df, aes(x = charges, fill = sex)) +
  geom_density(alpha = 0.5) +  # Create a density plot 
  facet_wrap(~age_group) +  # Facet the plot by 'age_group'
  scale_fill_manual(values = c('salmon', 'lightblue')) +  # Set custom colors for genders
  ggtitle("Density of Charges by Gender and Age Group") +  # Add plot title
  xlab('Charges') +  # Label the x-axis
  ylab('Density') +  # Label the y-axis
  theme_minimal() +  # Use a minimal theme for a clean look
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size=12)  # Customize plot title font style
  )

```
```{r}
# Calculate mean charges by smoker status and gender
charges_by_smoker_gender <- df %>%
  group_by(smoker, sex) %>%
  summarize(mean_charges = mean(charges), .groups = 'drop')  # Calculate mean charges and drop grouping

# Print the summarized data
print(charges_by_smoker_gender)

# Boxplot: Charges by Smoker Status and Gender
ggplot(df, aes(x = smoker, y = charges, fill = sex)) +
  geom_boxplot() +  # Create boxplots for charges by smoker status and gender
  scale_fill_manual(values = c('salmon', 'lightblue')) +  # Set custom colors for sexes
  ggtitle("Charges by Smoker Status and Sex") +  # Add plot title
  theme(
    plot.title = element_text(size = 12, face = 'bold', hjust = 0.5)  # Customize title size and alignment
  ) +
  xlab('Smoker Status') +  # Label the x-axis
  ylab('Charges')  # Label the y-axis

```
```{r}
# Scatter Plot: Charges by BMI and Age Group
ggplot(df, aes(x = bmi, y = charges, color = age_group)) +
  geom_point(size = 3) +  # Create scatter plot with colored points, size set to 3
  facet_wrap(~age_group) +  # Facet the plot by 'age_group'
  scale_color_manual(values = c('blue', 'green', 'yellow', 'orange')) +  # Set custom colors for age groups
  ggtitle("Charges by BMI and Age Group") +  # Add plot title
  xlab("BMI") +  # Label the x-axis
  ylab("Charges") +  # Label the y-axis
  theme_minimal() +  # Use a minimal theme for a clean look
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5)  # Customize the title font style
  )

```

```{r}
# Select only numeric columns from the dataframe
df_numeric <- df[sapply(df, is.numeric)]

# Calculate the correlation matrix for numeric columns
corr_matrix <- cor(df_numeric, use = 'pairwise.complete.obs')

# Print the correlation matrix
corr_matrix
```
```{r}
# Visualize the correlation matrix with customized formatting
corrplot(corr_matrix, 
         method = 'color',         # Color gradient to represent correlation coefficients
         type = 'upper',           # Show only the upper triangle of the matrix
         tl.cex = 0.8,             # Text label size (0.8 is slightly smaller than default)
         tl.col = 'black',         # Text label color
         number.cex = 0.7,         # Size of the numbers in the plot (0.7 is slightly smaller)
         col = colorRampPalette(c('blue', 'white', 'red'))(200),  # Color gradient from blue to red
         addCoef.col = 'black',    # Color of the correlation coefficients text
         diag = FALSE)             # Exclude the diagonal from the plot
```
```{r}
# Convert categorical variables to factors
df$sex <- as.factor(df$sex)
df$smoker <- as.factor(df$smoker)
df$region <- as.factor(df$region)
df$age_group <- as.factor(df$age_group)

# Split the dataset into training and testing sets
split <- initial_split(df, prop = 0.8)  # 80% training data, 20% testing data
train_data <- training(split)  # Training data
test_data <- testing(split)    # Testing data

# Fit a linear regression model
model <- lm(charges ~ bmi + age_group + sex + region + smoker, data = train_data)

# Display the summary of the linear regression model
summary(model)
```
```{r}
# Make predictions on the test data
predictions <- predict(model, newdata = test_data)

# Add the predictions to the test data
test_data$predicted_charges <- predictions

# Display the first few rows of the test data with predictions
head(test_data)

# Calculate Mean Absolute Error (MAE)
mae <- mean(abs(test_data$charges - test_data$predicted_charges))
mae  

# Calculate Mean Squared Error (MSE)
mse <- mean((test_data$charges - test_data$predicted_charges)^2)
mse  

# Calculate Root Mean Squared Error (RMSE)
rmse <- sqrt(mse)
rmse  


```
```{r}
# Plot residuals versus predicted charges
ggplot(test_data, aes(x = predicted_charges, y = charges - predicted_charges)) +
  geom_point() +  # Plot the residuals as points
  geom_hline(yintercept = 0, color = "red") +  # Add a horizontal line at y = 0
  ggtitle("Residuals vs Predicted Charges") +  # Add plot title
  xlab("Predicted Charges") +  # Label x-axis
  ylab("Residuals") + # Label y-axis
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5)  # Customize the title font style
  )
```



```{r}
# Plot actual vs predicted values
ggplot(test_data, aes(x = charges, y = predicted_charges)) +
geom_point() +
geom_abline(intercept = 0, slope = 1, color = "red") +
ggtitle("Actual vs Predicted Charges") +
xlab("Actual Charges") +
ylab("Predicted Charges") +
    # Use a minimal theme for a clean look
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5)  # Customize the title font style
  )

```

